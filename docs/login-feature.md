# ログイン機能 - 要件と設計案

## 1. 概要

このドキュメントでは、Remix Todoアプリケーションへのログイン機能追加に関する要件と設計案について説明します。ユーザー認証を導入することで、Todo項目をユーザーごとに管理できるようになります。

## 2. 要件

### 機能要件

- ユーザー登録機能
  - メールアドレスとパスワードによる新規ユーザー登録
  - ユーザー名の設定
  - 入力バリデーション（メールアドレス形式、パスワード強度）

- ログイン機能
  - メールアドレスとパスワードによるログイン
  - セッション管理
  - ログイン状態の永続化

- ログアウト機能
  - 現在のセッションを終了する機能

- パスワード関連
  - パスワードリセット機能
  - パスワード変更機能

- 認証保護
  - 未認証ユーザーのアクセス制限
  - ユーザー固有のTodo項目へのアクセス制御

### 非機能要件

- セキュリティ
  - パスワードのハッシュ化保存
  - CSRF対策
  - レート制限の実装

- UX
  - レスポンシブなログインフォーム
  - エラーメッセージの適切な表示
  - ログイン状態の視覚的フィードバック

- パフォーマンス
  - 認証処理の応答時間は500ms以内

## 3. 技術選定

- 認証方式: セッションベース認証
- データストレージ: PostgreSQL
- セッション管理: Remix Sessionストレージ
- パスワードハッシュ: bcrypt
- フォームバリデーション: zod

## 4. データモデル

### ユーザーモデル

```typescript
interface User {
  id: string;          // UUIDv4
  email: string;       // ユニーク
  username: string;    // ユニーク
  passwordHash: string;
  createdAt: Date;
  updatedAt: Date;
}
```

## 5. ルート設計

- `/login` - ログインページ
- `/register` - ユーザー登録ページ
- `/logout` - ログアウト処理
- `/reset-password` - パスワードリセット
- `/profile` - ユーザープロファイル (認証必須)

## 6. コンポーネント設計

### 共通コンポーネント
- `AuthForm` - 認証関連のフォームコンポーネント
- `PasswordInput` - パスワード入力用コンポーネント
- `AuthErrorMessage` - 認証エラーメッセージ表示コンポーネント

### ページコンポーネント
- `LoginPage` - ログインフォームを表示
- `RegisterPage` - 新規登録フォームを表示
- `ProfilePage` - ユーザープロファイル編集画面

## 7. 認証フロー

### ログインフロー
1. ユーザーが `/login` にアクセス
2. メールアドレスとパスワードを入力
3. フォーム送信時にサーバーサイドで認証処理
4. 認証成功時はセッションを作成し、ホームページにリダイレクト
5. 認証失敗時はエラーメッセージを表示

### 登録フロー
1. ユーザーが `/register` にアクセス
2. 必要情報（メール、ユーザー名、パスワード）を入力
3. 入力値のバリデーション
4. アカウント作成処理
5. 成功時は自動ログインし、ホームページにリダイレクト

### ログアウトフロー
1. ユーザーがログアウトボタンをクリック
2. セッションを破棄
3. ログインページにリダイレクト

## 8. セキュリティ対策

- パスワードの安全なハッシュ化
  - bcryptを使用したパスワードハッシュ化
  - bcryptは自動的に安全なsaltを生成・管理
  - 各パスワードに一意のsaltを使用し、レインボーテーブル攻撃を防止
  - ストレッチング（複数回のハッシュ適用）により総当たり攻撃に対する耐性を強化
  - コストファクター（ハッシュの計算コスト）は12以上を推奨

- セッショントークンは安全なランダム値を使用
- クロスサイトリクエストフォージェリ（CSRF）対策の実装
- レート制限による総当たり攻撃対策
- HTTPSの強制

### 8.1 パスワードハッシュ化の実装例

```typescript
import * as bcrypt from 'bcrypt';

// パスワードハッシュ化（ユーザー登録時）
async function hashPassword(password: string): Promise<string> {
  // saltRounds（コストファクター）は、ハッシュの計算コスト
  // 値が大きいほどセキュリティは高くなるが、処理時間も増加
  const saltRounds = 12;
  
  // bcrypt.hash()は内部でsaltを自動生成
  return bcrypt.hash(password, saltRounds);
}

// パスワード検証（ログイン時）
async function verifyPassword(password: string, hashedPassword: string): Promise<boolean> {
  // bcrypt.compare()は、ハッシュ内に埋め込まれたsalt情報を使用
  return bcrypt.compare(password, hashedPassword);
}
```

### 8.2 saltとは

saltとは、パスワードハッシュ化の前にパスワードに追加されるランダムなデータです。同じパスワードを持つユーザーでも、異なるsaltが使用されることで異なるハッシュ値が生成されます。これにより、以下のセキュリティ上の利点があります：

1. レインボーテーブル攻撃への対策: 事前計算された膨大なハッシュ値のテーブルによる攻撃が無効化される
2. 同一パスワードの検出防止: 同じパスワードを使用していても、異なるハッシュ値になるため第三者に発見されにくい

bcryptの優れている点は、ハッシュ値自体にsaltが組み込まれるため、saltを別途保存する必要がないことです。これにより実装が簡素化され、salt管理のミスによるセキュリティリスクも低減されます。

## 9. 実装計画

### フェーズ1：基本認証（優先実装）
- ユーザーモデルの実装
- 登録・ログイン・ログアウト機能
- 認証保護の実装

### フェーズ2：拡張機能
- パスワードリセット機能
- プロファイル編集機能
- 認証情報の永続化

### フェーズ3：セキュリティ強化
- 二要素認証
- ソーシャルログイン連携

## 10. テスト計画

- ユニットテスト: 認証ロジックのテスト
- 統合テスト: APIエンドポイントのテスト
- E2Eテスト: ログイン/登録フローのテスト

## 11. 今後の検討事項

- ソーシャルログイン（Google、GitHub）の導入
- 二要素認証の追加
- ロールベースのアクセス制御